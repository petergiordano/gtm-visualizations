<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced AI Positioning Simulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .p5-container {
             display: flex;
             justify-content: center;
             align-items: flex-start; /* Align to top */
             flex-direction: column;
             gap: 1rem;
             padding: 1rem;
             min-height: 50vh;
        }
        @media (min-width: 768px) {
            .p5-container {
                flex-direction: row;
            }
        }
        .ai-input textarea {
            transition: all 0.3s ease;
        }
        .ai-input textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #ffffff;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-900 mb-2">The Art of Positioning</h1>
            <p class="text-xl text-slate-600 max-w-3xl mx-auto">This advanced simulation visualizes how different companies value your specific features. Look for the colored clusters that place the highest value on your unique attributes.</p>
        </header>

        <!-- Mode Toggle -->
        <div class="text-center mb-8">
            <div class="inline-flex rounded-lg shadow-sm">
                <button id="demo-mode-btn" class="px-6 py-3 text-base font-medium bg-blue-600 text-white border border-blue-600 rounded-l-lg hover:bg-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-500">
                    Canned Demo
                </button>
                <button id="ai-mode-btn" class="px-6 py-3 text-base font-medium bg-white text-slate-700 border-t border-b border-r border-slate-300 rounded-r-lg hover:bg-slate-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-500">
                    ✨ AI Simulator
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="content-area">
            <!-- P5 Visualization Canvas -->
            <div class="p5-container bg-white rounded-xl shadow-lg border border-slate-200">
                <div class="flex flex-col md:flex-row gap-4 w-full">
                    <div id="canvas-wrapper" class="flex-grow">
                         <div id="canvas-container" class="mx-auto"></div>
                    </div>
                    <div id="legend-container" class="w-full md:w-48 p-2">
                        <h4 class="font-bold text-slate-700 mb-2 text-base hidden" id="legend-title">Company Personas</h4>
                        <div id="legend-content" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- Demo Controls & Explanation -->
            <div id="demo-controls" class="text-center mt-6">
                 <div id="p5-controls-container" class="mb-6"></div>
                 <div id="explanation" class="text-center p-6 bg-blue-50 border border-blue-200 rounded-lg max-w-3xl mx-auto hidden">
                     <h3 class="font-bold text-2xl text-blue-800 mb-2">Analysis Complete</h3>
                     <p class="text-lg text-blue-700">The simulation is finished. Your ideal target companies—those who value your unique features most—are now highlighted with a <span class="font-bold" style="color: #FBBF24;">gold</span> halo. Focus your efforts on them!</p>
                 </div>
            </div>

            <!-- AI Input and Results Section -->
            <div id="ai-section" class="hidden">

                <!-- Step 1: AI Market Analyzer -->
                <div id="ai-market-analyzer" class="mt-6 max-w-4xl mx-auto p-6 bg-white rounded-xl shadow-lg border border-slate-200">
                    <h2 class="text-3xl font-bold text-slate-800 mb-2 text-center">Step 1: AI Market Analyzer</h2>
                    <p class="text-center text-lg text-slate-600 mb-6">Struggling to define your features? Describe your product in your own words, and our AI analyst will suggest a starting point for your unique and common attributes.</p>
                    <label for="product-description" class="block text-base font-medium text-slate-700 mb-1">In your own words, describe your product, the problem it solves, and any competitors or alternatives you're aware of.</label>
                    <textarea id="product-description" rows="5" class="w-full p-2 border border-slate-300 rounded-md text-base" placeholder="e.g., We're building a tool that helps data scientists collaborate. Unlike traditional SQL notebooks, we offer real-time editing, automatic version history for queries, and AI-powered suggestions to write better code faster. Competitors are tools like Jupyter and Deepnote."></textarea>
                    <div class="text-center mt-6">
                        <button id="ai-analyze-market-button" class="w-full md:w-auto bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300 flex items-center justify-center mx-auto">
                            <span class="mr-2">Analyze My Market</span>
                            <div id="analyzer-spinner" class="spinner hidden"></div>
                        </button>
                    </div>
                     <div class="text-center mt-4">
                        <button id="skip-analyzer-btn" class="text-base text-slate-500 hover:text-slate-700">or, skip and enter attributes manually &raquo;</button>
                    </div>
                </div>

                <!-- Step 2: Attribute Input & Simulation -->
                <div id="ai-attribute-input" class="hidden mt-6 max-w-4xl mx-auto p-6 bg-white rounded-xl shadow-lg border border-slate-200">
                    <h2 class="text-3xl font-bold text-slate-800 mb-2 text-center">Step 2: Review Attributes & Simulate</h2>
                    <p class="text-center text-lg text-slate-600 mb-6">Our AI has drafted a list of attributes based on your description. Review, edit, and then run the simulation to see how different customer personas might value them.</p>

                    <div class="text-center mb-6">
                        <button id="example-posh-btn" class="bg-indigo-100 text-indigo-700 font-bold py-3 px-6 rounded-lg shadow-sm hover:bg-indigo-200 transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                            See an Example: Analyze 'POSH'
                        </button>
                    </div>

                    <div class="grid grid-cols-1">
                        <div>
                             <label for="unique-features" class="block text-base font-medium text-slate-700 mb-1">Your Unique Attributes (comma-separated)</label>
                            <textarea id="unique-features" rows="2" class="w-full p-2 border border-slate-300 rounded-md text-base" placeholder="e.g., Real-time collaboration, AI code suggestions, Automatic versioning"></textarea>
                        </div>
                        <div>
                            <label for="common-features" class="block text-base font-medium text-slate-700 mb-1">Common Attributes in Market (comma-separated)</label>
                            <textarea id="common-features" rows="2" class="w-full p-2 border border-slate-300 rounded-md text-base" placeholder="e.g., SQL notebooks, Basic charting, Data connectors"></textarea>
                        </div>
                    </div>
                     <div class="text-center mt-6">
                        <button id="ai-simulate-button" class="w-full md:w-auto bg-emerald-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-emerald-700 transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-emerald-300 flex items-center justify-center mx-auto">
                            <span class="mr-2">✨ Generate AI Simulation</span>
                            <div id="spinner" class="spinner hidden"></div>
                        </button>
                    </div>
                </div>

                <div id="ai-results-section" class="mt-8 max-w-4xl mx-auto hidden">
                    <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                        <h2 class="text-3xl font-bold text-slate-800 mb-4 text-center">✨ AI-Powered Strategic Analysis</h2>
                        <div id="ai-personas-container" class="space-y-4">
                           <!-- AI will populate this section -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Globals and Setup ---
        let currentMode = 'demo';

        // --- UI Control Functions ---
        function showMarketAnalyzer() {
            document.getElementById('ai-market-analyzer').classList.remove('hidden');
            document.getElementById('ai-attribute-input').classList.add('hidden');
            document.getElementById('ai-results-section').classList.add('hidden');
        }

        function showAttributeInput() {
            document.getElementById('ai-market-analyzer').classList.add('hidden');
            document.getElementById('ai-attribute-input').classList.remove('hidden');
            document.getElementById('ai-results-section').classList.add('hidden');
        }

        // --- Gemini API Calls ---

        /**
         * New Function: Calls Gemini to analyze a product description and extract attributes.
         */
        async function handleMarketAnalysis() {
            const productDescription = document.getElementById('product-description').value;
            if (!productDescription) {
                // Using a custom modal instead of alert
                showModal('Please describe your product to use the AI Market Analyzer.');
                return;
            }

            const button = document.getElementById('ai-analyze-market-button');
            const spinner = document.getElementById('analyzer-spinner');

            button.disabled = true;
            spinner.classList.remove('hidden');

            const prompt = `
                You are a world-class market analyst and B2B SaaS positioning expert.
                A startup founder has provided a description of their product.
                Your task is to analyze this description and the market it implies.
                Based on your knowledge, identify a list of "Common Attributes" (features that are table stakes in this market) and a list of "Unique Attributes" (features that appear to be the startup's key differentiators).

                Founder's Description: "${productDescription}"

                Return ONLY a valid JSON object with the following structure:
                {
                  "common_attributes": ["Attribute 1", "Attribute 2", ...],
                  "unique_attributes": ["Attribute 1", "Attribute 2", ...]
                }
            `;

            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            common_attributes: {
                                type: "ARRAY",
                                items: { "type": "STRING" }
                            },
                            unique_attributes: {
                                type: "ARRAY",
                                items: { "type": "STRING" }
                            }
                        },
                        required: ["common_attributes", "unique_attributes"]
                    }
                }
            };

            try {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const result = await response.json();

                 if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts.length > 0) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const data = JSON.parse(jsonText);

                    document.getElementById('common-features').value = data.common_attributes.join(', ');
                    document.getElementById('unique-features').value = data.unique_attributes.join(', ');

                    showAttributeInput(); // Move to the next step
                } else {
                    throw new Error("Invalid response structure from Market Analyzer API.");
                }

            } catch (error) {
                console.error("Error calling Market Analyzer API:", error);
                showModal("An error occurred during market analysis. Please check the console and try again.");
            } finally {
                button.disabled = false;
                spinner.classList.add('hidden');
            }
        }


        /**
         * Existing Function: Calls Gemini to generate personas based on attributes.
         */
        async function handleAiSimulation() {
            const uniqueFeatures = document.getElementById('unique-features').value;
            const commonFeatures = document.getElementById('common-features').value;

            if (!uniqueFeatures || !commonFeatures) {
                showModal('Please fill out all feature fields to generate the AI simulation.');
                return;
            }

            const button = document.getElementById('ai-simulate-button');
            const spinner = document.getElementById('spinner');
            const resultsSection = document.getElementById('ai-results-section');
            const personasContainer = document.getElementById('ai-personas-container');

            button.disabled = true;
            spinner.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            personasContainer.innerHTML = '';

            const prompt = `
                You are a world-class venture capitalist and market positioning expert.
                A startup founder provides you with their unique and common product attributes.
                - Unique Attributes: "${uniqueFeatures}"
                - Common Attributes: "${commonFeatures}"

                Your task is to generate a realistic market simulation. Create 4-5 distinct customer personas that would exist in this market. For each persona, describe them and analyze how they would value EACH of the provided attributes.

                Return ONLY a valid JSON object. The root should be an object with a "personas" key, which is an array of persona objects. Each persona object must have the following structure:
                {
                  "personaName": "A descriptive name (e.g., 'Ideal Early Adopter', 'Status Quo Buyer')",
                  "description": "A brief, 1-2 sentence description of this customer type.",
                  "attributes": [
                    {
                      "name": "The exact name of the attribute from the user's input",
                      "type": "'unique' or 'common'",
                      "value": "A score from 0 (low value) to 10 (high value) representing how much this persona cares about this attribute."
                    }
                  ]
                }
                Make sure the "attributes" array includes EVERY attribute provided by the user.
            `;

            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                           personas: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        personaName: { type: "STRING" },
                                        description: { type: "STRING" },
                                        attributes: {
                                            type: "ARRAY",
                                            items: {
                                                type: "OBJECT",
                                                properties: {
                                                    name: { type: "STRING" },
                                                    type: { type: "STRING" },
                                                    value: { type: "NUMBER" },
                                                },
                                                required: ["name", "type", "value"]
                                            }
                                        }
                                    },
                                    required: ["personaName", "description", "attributes"]
                                }
                           }
                        },
                        required: ["personas"]
                    }
                }
            };

            try {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const result = await response.json();

                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts.length > 0) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const aiData = JSON.parse(jsonText);

                    personasContainer.innerHTML = ''; // Clear previous results
                    aiData.personas.forEach(persona => {
                        const personaEl = document.createElement('div');
                        personaEl.className = 'bg-slate-50 p-4 rounded-lg border border-slate-200';
                        personaEl.innerHTML = `
                            <h3 class="font-semibold text-xl text-slate-700">${persona.personaName}</h3>
                            <p class="text-base text-slate-600 mt-1">${persona.description}</p>
                        `;
                        personasContainer.appendChild(personaEl);
                    });

                    resultsSection.classList.remove('hidden');
                    window.p5Sketch.runAiSimulation(aiData.personas);

                } else {
                    throw new Error("Invalid response structure from Persona API.");
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showModal("An error occurred while generating the AI simulation. Please check the console for details.");
            } finally {
                button.disabled = false;
                spinner.classList.add('hidden');
            }
        }

        function handlePoshExample() {
            document.getElementById('unique-features').value = 'Predictive Analytics and Machine Learning, Enhanced Automated Problem Resolution, Cross-Platform Integration Capabilities';
            document.getElementById('common-features').value = 'Reactive Monitoring, Custom Dashboards, Manual Troubleshooting, Basic Alerting';
            showAttributeInput(); // Make sure the attribute section is visible
            handleAiSimulation();
        }
        
        // --- Custom Modal for Alerts ---
        function showModal(message) {
            let modal = document.getElementById('alert-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'alert-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                        <p id="modal-message" class="text-base text-slate-700 mb-4"></p>
                        <button id="modal-close-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 text-base">OK</button>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('modal-close-btn').onclick = () => modal.style.display = 'none';
            }
            document.getElementById('modal-message').innerText = message;
            modal.style.display = 'flex';
        }

        // --- p5.js Sketch ---
        let sketch = function(p) {
            let companies = [];
            let simulationState = 'idle';
            let targetZone;
            let simButton, resetButton;
            let companyColors;
            let animationInterval;
            
            const demoPersonas = [
                { 
                    personaName: "Ideal Adopter", 
                    attributes: [
                        { name: "Unique A", type: 'unique', value: 9 }, { name: "Unique B", type: 'unique', value: 8 },
                        { name: "Common X", type: 'common', value: 5 }, { name: "Common Y", type: 'common', value: 4 }
                    ]
                },
                {
                    personaName: "Status Quo Buyer",
                    attributes: [
                        { name: "Unique A", type: 'unique', value: 2 }, { name: "Unique B", type: 'unique', value: 3 },
                        { name: "Common X", type: 'common', value: 9 }, { name: "Common Y", type: 'common', value: 8 }
                    ]
                },
                {
                    personaName: "Bargain Hunter",
                    attributes: [
                         { name: "Unique A", type: 'unique', value: 6 }, { name: "Unique B", type: 'unique', value: 5 },
                         { name: "Common X", type: 'common', value: 6 }, { name: "Common Y", type: 'common', value: 7 }
                    ]
                },
                {
                    personaName: "Legacy Loyalist",
                    attributes: [
                         { name: "Unique A", type: 'unique', value: 1 }, { name: "Unique B", type: 'unique', value: 1 },
                         { name: "Common X", type: 'common', value: 10 }, { name: "Common Y", type: 'common', value: 9 }
                    ]
                },
                 {
                    personaName: "Indifferent Buyer",
                    attributes: [
                         { name: "Unique A", type: 'unique', value: 1 }, { name: "Unique B", type: 'unique', value: 2 },
                         { name: "Common X", type: 'common', value: 3 }, { name: "Common Y", type: 'common', value: 4 }
                    ]
                }
            ];

            p.setup = function() {
                const wrapper = document.getElementById('canvas-wrapper');
                let canvasWidth = wrapper.offsetWidth;
                if (window.innerWidth < 768) {
                    canvasWidth = window.innerWidth * 0.85;
                }
                const canvasHeight = canvasWidth * 0.75;
                let canvas = p.createCanvas(canvasWidth, canvasHeight);
                canvas.parent('canvas-container');
                p.frameRate(60);

                companyColors = [
                    p.color(59, 130, 246), p.color(16, 185, 129), p.color(239, 68, 68),
                    p.color(139, 92, 246), p.color(245, 158, 11)
                ];

                const p5ControlsContainer = document.getElementById('p5-controls-container');
                simButton = p.createButton('Run Demo Simulation');
                simButton.parent(p5ControlsContainer);
                simButton.addClass('bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-blue-700');
                simButton.mousePressed(p.startSimulation);

                resetButton = p.createButton('Reset');
                resetButton.parent(p5ControlsContainer);
                resetButton.addClass('bg-slate-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-slate-700 ml-4');
                resetButton.mousePressed(p.resetSimulation);

                window.p5Sketch = { runAiSimulation: p.runAiSimulation };

                // --- Event Listeners ---
                document.getElementById('demo-mode-btn').addEventListener('click', () => switchMode('demo'));
                document.getElementById('ai-mode-btn').addEventListener('click', () => switchMode('ai'));
                document.getElementById('ai-analyze-market-button').addEventListener('click', handleMarketAnalysis);
                document.getElementById('skip-analyzer-btn').addEventListener('click', showAttributeInput);
                document.getElementById('ai-simulate-button').addEventListener('click', handleAiSimulation);
                document.getElementById('example-posh-btn').addEventListener('click', handlePoshExample);


                setupInitialState();
                p.resetSimulation(); // This will set up the initial demo view
            };

            function switchMode(newMode) {
                if (currentMode === newMode) return;
                currentMode = newMode;
                
                const demoControls = document.getElementById('demo-controls');
                const aiSection = document.getElementById('ai-section');
                const demoModeBtn = document.getElementById('demo-mode-btn');
                const aiModeBtn = document.getElementById('ai-mode-btn');
                const p5Controls = document.getElementById('p5-controls-container');

                if (newMode === 'demo') {
                    demoModeBtn.classList.add('bg-blue-600', 'text-white');
                    demoModeBtn.classList.remove('bg-white', 'text-slate-700');
                    aiModeBtn.classList.add('bg-white', 'text-slate-700');
                    aiModeBtn.classList.remove('bg-blue-600', 'text-white');
                    aiSection.classList.add('hidden');
                    demoControls.classList.remove('hidden');
                    p5Controls.classList.remove('hidden');
                } else {
                    aiModeBtn.classList.add('bg-blue-600', 'text-white');
                    aiModeBtn.classList.remove('bg-white', 'text-slate-700');
                    demoModeBtn.classList.add('bg-white', 'text-slate-700');
                    demoModeBtn.classList.remove('bg-blue-600', 'text-white');
                    demoControls.classList.add('hidden');
                    aiSection.classList.remove('hidden');
                    p5Controls.classList.add('hidden');
                    showMarketAnalyzer(); // Start AI mode at step 1
                }
                p.resetSimulation();
            }

            function setupInitialState() {
                targetZone = { x: p.width / 2, y: 0, w: p.width / 2, h: p.height / 2 };
            }

            p.draw = function() {
                p.background(255);
                drawGrid();
                
                if (currentMode === 'demo' || simulationState === 'finished') {
                    highlightTargetZone();
                }

                for (const company of companies) {
                    company.display();
                }
                
                drawLabels();
            };

            function runAnimation(onComplete) {
                if (simulationState === 'simulating') return;
                simulationState = 'simulating';
                
                let companyIndex = 0;
                animationInterval = setInterval(() => {
                    if(companyIndex < companies.length) {
                        companies[companyIndex].visible = true;
                        p.redraw();
                        companyIndex++;
                    } else {
                        clearInterval(animationInterval);
                        simulationState = 'finished';
                        if (onComplete) {
                            onComplete();
                        }
                        p.redraw();
                    }
                }, 600);
            }

            p.startSimulation = function() {
                 simButton.attribute('disabled', '');
                 simButton.addClass('opacity-50');
                 document.getElementById('explanation').classList.add('hidden');
                 runAnimation(() => {
                    analyzeAndHighlightIdealCompanies();
                    updateLegend();
                    simButton.removeAttribute('disabled');
                    simButton.removeClass('opacity-50');
                    document.getElementById('explanation').classList.remove('hidden');
                 });
            }

            p.runAiSimulation = function(personas) {
                p.resetSimulation();
                createCompaniesFromPersonas(personas);
                updateLegend();
                runAnimation(() => {
                    analyzeAndHighlightIdealCompanies();
                    updateLegend();
                });
            }

            p.resetSimulation = function() {
                clearInterval(animationInterval);
                simulationState = 'idle';
                companies = [];
                
                if (simButton) {
                    simButton.removeAttribute('disabled');
                    simButton.removeClass('opacity-50');
                }
                document.getElementById('explanation').classList.add('hidden');
                document.getElementById('ai-results-section').classList.add('hidden');
                
                if (currentMode === 'demo') {
                    createCompaniesFromPersonas(demoPersonas);
                    updateLegend();
                } else {
                    document.getElementById('legend-content').innerHTML = '';
                    document.getElementById('legend-title').classList.add('hidden');
                }

                p.redraw();
            }

            function analyzeAndHighlightIdealCompanies() {
                for(const company of companies) {
                    company.isIdeal = false; // Reset first
                    let uniqueValueScore = 0;
                    let uniqueAttrCount = 0;

                    for (const attr of company.attributes) {
                         if (attr.type === 'unique') {
                            uniqueAttrCount++;
                            if (attr.y < p.height / 2) {
                                uniqueValueScore++;
                            }
                         }
                    }

                    if (uniqueAttrCount > 0 && (uniqueValueScore / uniqueAttrCount) >= 0.5) {
                        company.isIdeal = true;
                    }
                }
            }

            function updateLegend() {
                const legendContent = document.getElementById('legend-content');
                const legendTitle = document.getElementById('legend-title');
                legendContent.innerHTML = '';
                if(companies.length === 0) {
                    legendTitle.classList.add('hidden');
                    return;
                }

                legendTitle.classList.remove('hidden');

                companies.forEach(company => {
                    const color = company.color.toString('#rrggbb');
                    const haloClass = company.isIdeal ? 'ring-2 ring-offset-1 ring-amber-400' : '';
                    const legendItem = document.createElement('div');
                    legendItem.className = 'flex items-center text-base';
                    legendItem.innerHTML = `
                        <div class="w-4 h-4 rounded-full mr-2 ${haloClass}" style="background-color: ${color}"></div>
                        <span>${company.name}</span>
                    `;
                    legendContent.appendChild(legendItem);
                });
            }

            function createCompaniesFromPersonas(personas) {
                 companies = personas.map((persona, index) => {
                    const company = new Company(persona.personaName, companyColors[index % companyColors.length]);
                    persona.attributes.forEach(attr => {
                        const valueY = p.map(attr.value, 0, 10, p.height * 0.95, p.height * 0.05);
                        const typeX = (attr.type === 'unique') ? p.random(p.width * 0.55, p.width * 0.95) : p.random(p.width * 0.05, p.width * 0.45);
                        company.addAttribute(typeX, valueY, attr.name, attr.type);
                    });
                    return company;
                });
            }

            function drawGrid() {
                p.stroke(226, 232, 240); p.strokeWeight(2);
                p.line(p.width / 2, 0, p.width / 2, p.height);
                p.line(0, p.height / 2, p.width, p.height / 2);
            }

            function drawLabels() {
                p.noStroke(); p.fill(100, 116, 139); p.textAlign(p.CENTER, p.CENTER); p.textSize(18);
                p.push(); p.translate(25, p.height / 4); p.rotate(-p.HALF_PI);
                p.text("High Customer Value", 0, 0); p.pop();
                p.push(); p.translate(25, p.height * 3 / 4); p.rotate(-p.HALF_PI);
                p.text("Low Customer Value", 0, 0); p.pop();
                p.text("Common Attributes", p.width / 4, p.height - 30);
                p.text("Your Unique Attributes", p.width * 3 / 4, p.height - 30);
            }

            function highlightTargetZone() {
                p.fill(251, 191, 36, 20); // amber-400 with low opacity
                p.stroke(251, 191, 36, 100); 
                p.strokeWeight(2);
                p.rect(targetZone.x, targetZone.y, targetZone.w, targetZone.h);
            }

            class Company {
                constructor(name, color) {
                    this.name = name;
                    this.color = color;
                    this.attributes = [];
                    this.visible = false;
                    this.isIdeal = false;
                }
                addAttribute(x, y, name, type) {
                    this.attributes.push({x, y, name, type});
                }
                display() {
                    if (!this.visible) return;
                    
                    // Loop through each attribute of the company
                    for (const attr of this.attributes) {
                        
                        // If the company is an ideal target, first draw a halo
                        if(this.isIdeal) {
                             p.fill(251, 191, 36, 150); // amber-400
                             p.noStroke();
                             p.ellipse(attr.x, attr.y, 16, 16);
                        }
                        
                        // Then, draw the actual attribute dot on top
                        p.fill(this.color);
                        p.noStroke();
                        p.ellipse(attr.x, attr.y, 10, 10);
                    }
                }
            }
        };

        window.onload = function() {
            new p5(sketch);
        }
    </script>
</body>
</html>